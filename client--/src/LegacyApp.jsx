import { useMemo, useState } from 'react'
import Header from './components/layout/Header'
import SideNav from './components/navigation/SideNav'
import LoginPanel from './components/auth/LoginPanel'
import MatchHistory from './components/MatchHistory'
import ChessGameBot from './components/playbot/ChessGameBot'
import './LegacyApp.css'

const PIECE_ORDER = ['rook', 'knight', 'bishop', 'queen', 'king', 'bishop', 'knight', 'rook']

const PIECE_SYMBOLS = {
  white: {
    king: '‚ôî',
    queen: '‚ôï',
    rook: '‚ôñ',
    bishop: '‚ôó',
    knight: '‚ôò',
    pawn: '‚ôô',
  },
  black: {
    king: '‚ôö',
    queen: '‚ôõ',
    rook: '‚ôú',
    bishop: '‚ôù',
    knight: '‚ôû',
    pawn: '‚ôüÔ∏é',
  },
}

const PIECE_NAMES = {
  king: 'Vua',
  queen: 'H·∫≠u',
  rook: 'Xe',
  bishop: 'T∆∞·ª£ng',
  knight: 'M√£',
  pawn: 'T·ªët',
}

const FILES = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h']

const createInitialBoard = () => {
  const board = Array.from({ length: 8 }, () => Array(8).fill(null))

  board[0] = PIECE_ORDER.map((type) => ({ type, color: 'black', hasMoved: false }))
  board[1] = Array.from({ length: 8 }, () => ({ type: 'pawn', color: 'black', hasMoved: false }))
  board[6] = Array.from({ length: 8 }, () => ({ type: 'pawn', color: 'white', hasMoved: false }))
  board[7] = PIECE_ORDER.map((type) => ({ type, color: 'white', hasMoved: false }))

  return board
}

const cloneBoard = (board) =>
  board.map((row) => row.map((cell) => (cell ? { ...cell } : null)))

const toNotation = (row, col) => `${FILES[col]}${8 - row}`

const describePiece = (piece) =>
  `${piece.color === 'white' ? 'Tr·∫Øng' : 'ƒêen'} ${PIECE_NAMES[piece.type]}`

const capitalizeColor = (color) => (color === 'white' ? 'Tr·∫Øng' : 'ƒêen')

const formatMoveText = (piece, from, to, isCapture) => {
  const action = isCapture ? 'x' : '‚Üí'
  return `${capitalizeColor(piece.color)} ${PIECE_NAMES[piece.type]} ${toNotation(
    from.row,
    from.col
  )} ${action} ${toNotation(to.row, to.col)}`
}

const getValidMoves = (board, row, col) => {
  const piece = board[row][col]
  if (!piece) return []

  const moves = []
  const inBounds = (r, c) => r >= 0 && r < 8 && c >= 0 && c < 8

  const addSlidingMoves = (directions) => {
    directions.forEach(([dr, dc]) => {
      let nextRow = row + dr
      let nextCol = col + dc
      while (inBounds(nextRow, nextCol)) {
        const target = board[nextRow][nextCol]
        if (!target) {
          moves.push({ row: nextRow, col: nextCol, capture: false })
        } else {
          if (target.color !== piece.color) {
            moves.push({ row: nextRow, col: nextCol, capture: true })
          }
          break
        }
        nextRow += dr
        nextCol += dc
      }
    })
  }

  switch (piece.type) {
    case 'pawn': {
      const direction = piece.color === 'white' ? -1 : 1
      const startRow = piece.color === 'white' ? 6 : 1
      const oneStep = row + direction
      if (inBounds(oneStep, col) && !board[oneStep][col]) {
        moves.push({ row: oneStep, col, capture: false })
        const twoStep = row + direction * 2
        if (row === startRow && inBounds(twoStep, col) && !board[twoStep][col]) {
          moves.push({ row: twoStep, col, capture: false })
        }
      }
      ;[-1, 1].forEach((offset) => {
        const targetCol = col + offset
        const targetRow = row + direction
        if (!inBounds(targetRow, targetCol)) return
        const target = board[targetRow][targetCol]
        if (target && target.color !== piece.color) {
          moves.push({ row: targetRow, col: targetCol, capture: true })
        }
      })
      break
    }
    case 'rook':
      addSlidingMoves([
        [1, 0],
        [-1, 0],
        [0, 1],
        [0, -1],
      ])
      break
    case 'bishop':
      addSlidingMoves([
        [1, 1],
        [1, -1],
        [-1, 1],
        [-1, -1],
      ])
      break
    case 'queen':
      addSlidingMoves([
        [1, 0],
        [-1, 0],
        [0, 1],
        [0, -1],
        [1, 1],
        [1, -1],
        [-1, 1],
        [-1, -1],
      ])
      break
    case 'knight': {
      const knightMoves = [
        [2, 1],
        [2, -1],
        [-2, 1],
        [-2, -1],
        [1, 2],
        [1, -2],
        [-1, 2],
        [-1, -2],
      ]
      knightMoves.forEach(([dr, dc]) => {
        const nextRow = row + dr
        const nextCol = col + dc
        if (!inBounds(nextRow, nextCol)) return
        const target = board[nextRow][nextCol]
        if (!target) {
          moves.push({ row: nextRow, col: nextCol, capture: false })
        } else if (target.color !== piece.color) {
          moves.push({ row: nextRow, col: nextCol, capture: true })
        }
      })
      break
    }
    case 'king': {
      const kingMoves = [
        [1, 0],
        [-1, 0],
        [0, 1],
        [0, -1],
        [1, 1],
        [1, -1],
        [-1, 1],
        [-1, -1],
      ]
      kingMoves.forEach(([dr, dc]) => {
        const nextRow = row + dr
        const nextCol = col + dc
        if (!inBounds(nextRow, nextCol)) return
        const target = board[nextRow][nextCol]
        if (!target) {
          moves.push({ row: nextRow, col: nextCol, capture: false })
        } else if (target.color !== piece.color) {
          moves.push({ row: nextRow, col: nextCol, capture: true })
        }
      })
      break
    }
    default:
      break
  }

  return moves
}

function LegacyApp() {
  const [board, setBoard] = useState(() => createInitialBoard())
  const [selectedSquare, setSelectedSquare] = useState(null)
  const [turn, setTurn] = useState('white')
  const [history, setHistory] = useState([])
  const [captured, setCaptured] = useState({ white: [], black: [] })
  const [gameMessage, setGameMessage] = useState('Tr·∫Øng ƒëi tr∆∞·ªõc')
  const [lastMove, setLastMove] = useState(null)
  const [gameStarted, setGameStarted] = useState(false)
  const [showLoginPanel, setShowLoginPanel] = useState(false)
  const [controlTab, setControlTab] = useState('newGame')
  const [, setShowBoardModal] = useState(false)
  const [showHistory, setShowHistory] = useState(false)
  const [activeTab, setActiveTab] = useState('play')
  const handleRegisterClick = () =>
    setGameMessage('ƒêƒÉng k√Ω t√†i kho·∫£n ƒëang ƒë∆∞·ª£c chu·∫©n b·ªã cho b·∫£n client ti·∫øp theo.')
  const handleLoginClick = () => {
    setShowLoginPanel(true)
    setGameMessage('M·ªü bi·ªÉu m·∫´u ƒëƒÉng nh·∫≠p ƒë·ªÉ k·∫øt n·ªëi v·ªõi c·ªông ƒë·ªìng.')
  }
  const handleLoginSubmit = (event) => {
    event.preventDefault()
    setShowLoginPanel(false)
    setGameMessage('ƒêƒÉng nh·∫≠p demo th√†nh c√¥ng, nh·∫•n Get Started ƒë·ªÉ v√†o b√†n c·ªù.')
  }
  const handleForgotPassword = () =>
    setGameMessage('Ch·ª©c nƒÉng qu√™n m·∫≠t kh·∫©u s·∫Ω xu·∫•t hi·ªán trong b·∫£n d·ª±ng ti·∫øp theo.')
  const handleCloseLogin = () => setShowLoginPanel(false)
  const handleLearnMore = () =>
    setGameMessage('Kh√°m ph√° c·ªông ƒë·ªìng v√† c√°c ch·∫ø ƒë·ªô luy·ªán t·∫≠p m·ªõi c·ªßa IT4062 Chessgame.')

  const validMoves = useMemo(() => {
    if (!selectedSquare) return []
    const { row, col } = selectedSquare
    const piece = board[row][col]
    if (!piece || piece.color !== turn) return []
    return getValidMoves(board, row, col)
  }, [board, selectedSquare, turn])

  const handleSquareClick = (row, col) => {
    const piece = board[row][col]

    if (selectedSquare && selectedSquare.row === row && selectedSquare.col === col) {
      setSelectedSquare(null)
      setGameMessage('ƒê√£ b·ªè ch·ªçn qu√¢n c·ªù')
      return
    }

    if (selectedSquare) {
      const move = validMoves.find((m) => m.row === row && m.col === col)
      if (move) {
        movePiece(selectedSquare, { row, col })
        return
      }
      if (piece && piece.color === turn) {
        setSelectedSquare({ row, col })
        setGameMessage(`Ch·ªçn √¥ ƒë·∫øn cho ${describePiece(piece)}`)
      } else {
        setSelectedSquare(null)
        setGameMessage('N∆∞·ªõc ƒëi kh√¥ng h·ª£p l·ªá')
      }
      return
    }

    if (piece && piece.color === turn) {
      setSelectedSquare({ row, col })
      setGameMessage(`Ch·ªçn √¥ ƒë·∫øn cho ${describePiece(piece)}`)
    } else if (piece) {
      setGameMessage('ƒê√¢y l√† qu√¢n c·ªßa ƒë·ªëi th·ªß')
    } else {
      setGameMessage('H√£y ch·ªçn m·ªôt qu√¢n c·ªù c·ªßa b·∫°n')
    }
  }

  const movePiece = (from, to) => {
    const movingPiece = board[from.row][from.col]
    if (!movingPiece) return
    const targetPiece = board[to.row][to.col]
    const updatedBoard = cloneBoard(board)
    updatedBoard[to.row][to.col] = { ...movingPiece, hasMoved: true }
    updatedBoard[from.row][from.col] = null

    setBoard(updatedBoard)

    if (targetPiece) {
      setCaptured((prev) => ({
        ...prev,
        [movingPiece.color]: [...prev[movingPiece.color], targetPiece],
      }))
    }

    const moveText = formatMoveText(movingPiece, from, to, Boolean(targetPiece))
    setHistory((prev) => [moveText, ...prev].slice(0, 16))
    const nextTurn = movingPiece.color === 'white' ? 'black' : 'white'
    setTurn(nextTurn)
    setSelectedSquare(null)
    setLastMove({ from, to })
    setGameMessage(
      targetPiece
        ? `${capitalizeColor(movingPiece.color)} v·ª´a ƒÉn ${describePiece(targetPiece)}`
        : `ƒê·∫øn l∆∞·ª£t ${capitalizeColor(nextTurn)}`
    )
  }

  const resetGame = (message = 'Tr·∫Øng ƒëi tr∆∞·ªõc') => {
    setBoard(createInitialBoard())
    setSelectedSquare(null)
    setTurn('white')
    setHistory([])
    setCaptured({ white: [], black: [] })
    setGameMessage(message)
    setLastMove(null)
  }

  const handleGetStarted = () => {
    setGameStarted(true)
    resetGame('B·∫Øt ƒë·∫ßu ngay m·ªôt v√°n m·ªõi v√† kh√°m ph√° h·ªá th·ªëng IT4062 Chessgame.')
    setShowBoardModal(true)
  }

  return (
    <div className="chess-shell">
      <SideNav
        onLoginClick={handleLoginClick}
        onRegisterClick={handleRegisterClick}
        onHistoryClick={() => setShowHistory(true)}
        onPlayBotsClick={() => setActiveTab('bot')}
      />
      <main className="main-area">
        <Header />
        {activeTab === 'play' && (
          <>
            {!gameStarted && (
              <>
                <section className="hero-section">
                  <div className="hero-text">
                    <p className="hero-label">IT4062 chess network</p>
                    <h1>Play chess. Improve your game. Have fun!</h1>
                    <p>
                      ƒêƒÉng nh·∫≠p ƒë·ªÉ t√¨m ƒë·ªëi th·ªß t·ª©c th√¨, luy·ªán t·∫≠p c√°c th·∫ø tr·∫≠n m·ªõi v√† theo d√µi c·ªông
                      ƒë·ªìng ch∆°i c·ªù nƒÉng ƒë·ªông nh·∫•t c·ªßa h·ªçc ph·∫ßn IT4062.
                    </p>
                    <div className="hero-actions">
                      <button type="button" className="primary-cta" onClick={handleGetStarted}>
                        Get Started
                      </button>
                      <button type="button" className="ghost-cta" onClick={handleLearnMore}>
                        Learn More
                      </button>
                    </div>
                  </div>
                  <div className="hero-visual" aria-hidden="true">
                    <div className="hero-floor" />
                    <div className="hero-piece hero-king" />
                    <div className="hero-piece hero-knight" />
                    <div className="hero-piece hero-pawn" />
                  </div>
                </section>

                <section className="prestart-panel">
                  <h2>S·∫µn s√†ng tranh t√†i</h2>
                  <p>T·∫°o t√†i kho·∫£n ho·∫∑c ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u l·∫°i l·ªãch s·ª≠ v√† th·ªëng k√™ n∆∞·ªõc ƒëi c·ªßa b·∫°n.</p>
                  <p>Nh·∫•n Get Started ƒë·ªÉ m·ªü ngay m·ªôt b√†n c·ªù th·ª≠ nghi·ªám.</p>
                  <div className="prestart-status">{gameMessage}</div>
                </section>
              </>
            )}

            {gameStarted && (
              <section className="play-section">
                <div className="board-column">
                  <div className="play-top">
                    <span className="play-mode">10 min Rapid</span>
                    <div className="play-settings">
                      <span>‚öôÔ∏è</span>
                      <span className="play-timer">10:00</span>
                    </div>
                  </div>
                  <div className="board-wrapper">
                    <div className="board-shell">
                      <div className="board">
                        {board.map((row, rowIndex) => (
                          <div className="board-row" key={`row-${rowIndex}`}>
                            {row.map((piece, colIndex) => {
                              const isDark = (rowIndex + colIndex) % 2 === 1
                              const isSelected =
                                selectedSquare &&
                                selectedSquare.row === rowIndex &&
                                selectedSquare.col === colIndex
                              const moveHighlight = validMoves.find(
                                (m) => m.row === rowIndex && m.col === colIndex
                              )
                              const isLastMoveSquare =
                                lastMove &&
                                ((lastMove.from.row === rowIndex &&
                                  lastMove.from.col === colIndex) ||
                                  (lastMove.to.row === rowIndex && lastMove.to.col === colIndex))
                              const squareClasses = [
                                'square',
                                isDark ? 'square-dark' : 'square-light',
                                isSelected ? 'square-selected' : '',
                                moveHighlight
                                  ? moveHighlight.capture
                                    ? 'square-capture'
                                    : 'square-move'
                                  : '',
                                isLastMoveSquare ? 'square-last' : '',
                              ]
                                .filter(Boolean)
                                .join(' ')
                              const symbol = piece ? PIECE_SYMBOLS[piece.color][piece.type] : ''
                              const ariaLabel = piece
                                ? `${describePiece(piece)} t·∫°i ${toNotation(rowIndex, colIndex)}`
                                : `√î tr·ªëng ${toNotation(rowIndex, colIndex)}`
                              return (
                                <button
                                  type="button"
                                  key={`col-${colIndex}`}
                                  className={squareClasses}
                                  onClick={() => handleSquareClick(rowIndex, colIndex)}
                                  aria-label={ariaLabel}
                                >
                                  {symbol}
                                  {moveHighlight && !moveHighlight.capture && (
                                    <span className="dot" />
                                  )}
                                </button>
                              )
                            })}
                          </div>
                        ))}
                      </div>
                      <div className="rank-labels rank-left">
                        {Array.from({ length: 8 }, (_, idx) => 8 - idx).map((rank) => (
                          <span key={`left-${rank}`}>{rank}</span>
                        ))}
                      </div>
                      <div className="rank-labels rank-right">
                        {Array.from({ length: 8 }, (_, idx) => 8 - idx).map((rank) => (
                          <span key={`right-${rank}`}>{rank}</span>
                        ))}
                      </div>
                      <div className="file-labels file-bottom">
                        {FILES.map((file) => (
                          <span key={`bottom-${file}`}>{file.toUpperCase()}</span>
                        ))}
                      </div>
                      <div className="file-labels file-top">
                        {FILES.map((file) => (
                          <span key={`top-${file}`}>{file.toUpperCase()}</span>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
                <div className="control-column">
                  <div className="control-tabs">
                    {[
                      { id: 'play', label: 'Ch∆°i' },
                      { id: 'newGame', label: 'V√°n c·ªù m·ªõi' },
                      { id: 'games', label: 'C√°c v√°n ƒë·∫•u' },
                      { id: 'players', label: 'C√°c k·ª≥ th·ªß' },
                    ].map((tab) => (
                      <button
                        type="button"
                        key={tab.id}
                        className={controlTab === tab.id ? 'active' : ''}
                        onClick={() => setControlTab(tab.id)}
                      >
                        {tab.label}
                      </button>
                    ))}
                  </div>
                  {controlTab === 'newGame' && (
                    <>
                      <div className="control-card accent">
                        <div>
                          <p className="control-label">Ch·∫ø ƒë·ªô</p>
                          <strong>10 min (Rapid)</strong>
                        </div>
                        <button
                          type="button"
                          className="control-primary"
                          onClick={() => resetGame('B·∫Øt ƒë·∫ßu ngay v√°n m·ªõi!')}
                        >
                          Start Game
                        </button>
                      </div>
                      <button type="button" className="control-card">
                        üß© Custom Challenge
                      </button>
                      <button type="button" className="control-card">
                        ü§ù Play a Friend
                      </button>
                      <button type="button" className="control-card">
                        üèÖ Tournaments
                      </button>
                    </>
                  )}
                  {controlTab === 'play' && (
                    <div className="move-panel">
                      <div className="move-tabs">
                        <button type="button" className="active">
                          C√°c n∆∞·ªõc ƒëi
                        </button>
                        <button type="button">Th√¥ng tin</button>
                      </div>
                      <div className="move-list">
                        {history.length ? (
                          history
                            .slice()
                            .reverse()
                            .map((entry, index) => (
                              <div className="move-row" key={`${entry}-${index}`}>
                                <span>{index + 1}.</span>
                                <p>{entry}</p>
                              </div>
                            ))
                        ) : (
                          <p className="muted">Ch∆∞a c√≥ n∆∞·ªõc ƒëi n√†o</p>
                        )}
                      </div>
                      <div className="move-controls">
                        <button type="button" aria-label="V·ªÅ ƒë·∫ßu">
                          ‚èÆ
                        </button>
                        <button type="button" aria-label="L√πi">
                          ‚è™
                        </button>
                        <button type="button" aria-label="Ph√°t">
                          ‚ñ∂
                        </button>
                        <button type="button" aria-label="Ti·∫øn">
                          ‚è©
                        </button>
                        <button type="button" aria-label="T·ªõi cu·ªëi">
                          ‚è≠
                        </button>
                      </div>
                      <div className="game-summary">
                        <p>V√°n c·ªù ƒëang di·ªÖn ra</p>
                        <small>IT4062 Rapid ‚Ä¢ 10 ph√∫t</small>
                        <button type="button" className="link-btn" onClick={() => setHistory([])}>
                          X√≥a l·ªãch s·ª≠
                        </button>
                      </div>
                      <div className="move-actions">
                        <button type="button">¬Ω H√≤a c·ªù</button>
                        <button type="button">üè≥Ô∏è ƒê·∫ßu H√†ng</button>
                        <button type="button" onClick={() => resetGame('B·∫Øt ƒë·∫ßu l·∫°i tr·∫≠n ƒë·∫•u!')}>
                          ‚ü≥ ƒê·∫•u l·∫°i
                        </button>
                      </div>
                    </div>
                  )}
                  {controlTab !== 'newGame' && controlTab !== 'play' && (
                    <div className="control-placeholder">
                      <p>
                        {controlTab === 'games'
                          ? 'Danh s√°ch v√°n ƒë·∫•u s·∫Øp ra m·∫Øt.'
                          : 'Tra c·ª©u k·ª≥ th·ªß s·∫Ω xu·∫•t hi·ªán trong b·∫£n t·ªõi.'}
                      </p>
                      <small>V√†o tab "V√°n c·ªù m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu m·ªôt tr·∫≠n.</small>
                    </div>
                  )}
                </div>
              </section>
            )}
          </>
        )}
        {activeTab === 'bot' && <ChessGameBot />}
      </main>
      {showLoginPanel && (
        <div className="login-overlay">
          <LoginPanel
            onSubmit={handleLoginSubmit}
            onForgot={handleForgotPassword}
            onClose={handleCloseLogin}
          />
        </div>
      )}
      {showHistory && (
        <div className="history-overlay">
          <div className="history-dialog">
            <div className="history-header">
              <div>
                <p className="history-eyebrow">More</p>
                <h3>L·ªãch s·ª≠ ch∆°i (Frontend API m·ªõi)</h3>
              </div>
              <button
                type="button"
                className="history-close"
                aria-label="ƒê√≥ng l·ªãch s·ª≠"
                onClick={() => setShowHistory(false)}
              >
                √ó
              </button>
            </div>
            <div className="history-content">
              <MatchHistory />
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

export default LegacyApp
